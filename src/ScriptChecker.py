'''
Created on 5 Mar 2020

@author: pipertod
'''

import re
from FileCheckResult import FileCheckResult
from JavaScriptScriptChecker import JavascriptScriptChecker
from PythonScriptChecker import PythonScriptChecker
from RScriptChecker import RScriptChecker
import FileSystemHelper

class ScriptChecker(object):
    '''
    classdocs
    '''

    def __init__(self):
        '''
        Constructor
        '''
        self.base64RegexObject = re.compile(r'(.*?base64.*?)\n')
        self.excludedFileExtensions = ['dll','rds','rdb','rdx','rda','pdf','RData','exe','com','mo']
        
        
    def getKeyword(self):
        return self.keyword
    
    def checkFile(self, filepath):
        with open(filepath, 'r') as fileInput:
            return self.checkFileInput(filepath, fileInput)
    
    def checkFileInput(self, filepath, fileInput):
        
        javascriptScriptChecker = JavascriptScriptChecker(self.base64RegexObject)
        rScriptChecker = RScriptChecker(self.base64RegexObject)
        pythonScriptChecker = PythonScriptChecker(self.base64RegexObject)

        # based on known extension add the appropriate language checker else add them all        
        languageScriptCheckers = []
        fileCheckResults = []
        
        fileExtension = FileSystemHelper.extension(filepath); 
        
        if fileExtension in self.excludedFileExtensions:
            fileCheckResult = FileCheckResult(checkName="Excluded Files",filepath=filepath, checkResult="File excluded from script check", suspicious=False, malware=False, reputation=False)
                
        else:
            
            if rScriptChecker.isFile(fileExtension):
                languageScriptCheckers.append(rScriptChecker)
            
            elif pythonScriptChecker.isFile(fileExtension):
                languageScriptCheckers.append(pythonScriptChecker) 
            
            elif javascriptScriptChecker.isFile(fileExtension):
                languageScriptCheckers.append(javascriptScriptChecker)
            
            else:
                # Incase its a new file extension we have accounted for or if it has been deliberately changed
                languageScriptCheckers.append(rScriptChecker)
                languageScriptCheckers.append(pythonScriptChecker)
                languageScriptCheckers.append(javascriptScriptChecker)
            
                #Run the file input over the checkers
        
            for line in fileInput:
                for languageScriptChecker in languageScriptCheckers:
                    languageScriptChecker.checkLine(line)
                
        
            # Collate toe results                
            for languageScriptChecker in languageScriptCheckers:
            
                checkName = languageScriptChecker.getLanguage()
                results = languageScriptChecker.getLines()
                suspicious = languageScriptChecker.isSuspicious()
            
                fileCheckResult = FileCheckResult(checkName=checkName,filepath=filepath, checkResult=results, suspicious=suspicious, malware=False, reputation=False)
                   
                fileCheckResults.append(fileCheckResult)
            
        return fileCheckResults
